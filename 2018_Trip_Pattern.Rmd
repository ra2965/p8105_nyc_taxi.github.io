---
title: "2018 Trip Pattern"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

```{r echo=FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(gganimate)
library(ggplot2)
library(plotly)
library(gifski)
```
   
     
## Temperature and Taxi Use
   
#### Background

Previous work have shown that there are relationships between taxi ridership and weather events.“During adverse weather, taxi drivers tend to make more money” (Kamga et al., 2013). Kamga et al. also found that during days when adverse weather took place, there was a higher demand for taxis in Manhattan compared to the other boroughs, and that more people were prone to take shorter taxi trips.

#### Data Tidy

In this part, we wanted to see whether there is a trend between weather and yellow cab within and between months use using our data. We used the weather data including temperature and precipitation data in 2018 and their corresponding yellow taxi use data. For temperature, we used average temperature `average_temp ` as the mean of maximum temperarure and miniminum temperature in each day. For yellow cab data, we used the raw data for 2018 from NYC Taxi Website, counted the daily taxi usage by `pick_up_data` and then joined the weather dataset by month and date.

```{r message = FALSE, warning = FALSE}
weather_tot=read_csv(file = "./data/weather_nyc_2018.csv")%>%
  mutate(date = as.character(date)) %>%
  separate(date, into = c("year","month","pu_date"), sep = "-", convert = TRUE)%>%
  mutate(
  average_temp=(tmin+tmax)/2)
  

yellowcab=read_csv(file = "./data/yearly_summary/2018_taxi_trip_daily_summary.csv")%>%
  mutate(date = as.character(vars),
         daily_drive=n) %>%
  separate(date, into = c("year","month","pu_date"), sep = "-", convert = TRUE)%>%
  select(-vars,-year)

cab_weather=
  left_join(weather_tot,yellowcab, by=c("month","pu_date"))%>%
  select(month, pu_date,average_temp, daily_drive,prcp)%>%
  mutate(month=as.factor(month),
         month=recode_factor(month, '1'="January", '2'="Feburary",'3'="March",'4'='April','5'='May','6'='June','7'='July','8'='August','9'='September','10'='October','11'='November','12'='December'))
```

#### Plot for the association between Weather and Daily Taxi Usage

Here we made an animation plot to show the daily drive amount and average daily temperature for each month.The size of the dots showed the precipitaiton for that day which help to identify whether rainy weather also increase taxi use. 

Although we hypothesized that cold weather and hot weather might have more taxi use, there was no obvious usage increase in summer time. While, we did observed high daily drive amount in Feburary, March and April which are the four coldest months in NYC. Also, no interaction between month and average temperature was being observed. In terms of the influence of precipitation, we didn't observe a significant pattern. Contrast to what we guessed before, instead of increase daily drive amount, rainy days had lower drive amount. This might due to the reason that people would just stay at home during days with heavy rain or snow. Also, if we adjustded for distance, there might be a significant association between precipitation and short distance drive. 

```{r message = FALSE, warning = FALSE}
weather_plot=cab_weather %>%
  ggplot(aes(x=average_temp, y=daily_drive, frame_vars(month)))+
  geom_point(aes(size=prcp,colour = month))+
   labs(title = 'Month: {closest_state}',
       x = 'Daily Average Temperature for Year 2018', 
       y = 'Daily Drive Amount',
       colour = 'Month',
       size='Precipitation'
       ) +
  transition_states(month,2,1)+
  enter_appear()+
  exit_fade()
   
animate(weather_plot, duration=12)
```


```{r, include=FALSE}
zone_lookup <-
  read_csv("./data/taxi_zone_lookup.csv") %>% 
  janitor::clean_names() %>% 
  select(-service_zone)

file_names <- list.files("./data/yellow_cab")
read_in = function(x) {
  read_csv("./data/yellow_cab/x") 
}
setwd("./data/yellow_cab")
taxi_2018 <-
  file_names %>% 
  set_names() %>% 
  map_dfr(read_csv, .id = "source") %>% 
  separate(source, c("a","b","year", "month", "c"), sep = "([\\.\\_])") %>% 
  select(-a, -b, -c, -X1)

```

```{r}
heatmap <-
  taxi_2018 %>% 
  filter(
    passenger_count != 0,
    trip_distance != 0,
    total_amount > 0,
    fare_amount != 0
  ) %>% 
  mutate(tpep_pickup_datetime = as.character(tpep_pickup_datetime),
         tpep_dropoff_datetime = as.character(tpep_dropoff_datetime)) %>%
  separate(tpep_pickup_datetime, into = c("a","b"), sep = " ") %>%
  separate(a, into = c("pick_year","pick_month","pu_date"), sep = "-") %>%
  separate(b, into = c("pu_hour","pu_min"), sep = ":") %>%
  separate(tpep_dropoff_datetime, into = c("c","d"),sep = " ") %>%
  separate(c,into = c("drop_year","drop_month","do_date"),sep = "-") %>%
  separate(d, into = c("do_hour","do_min"), sep = ":") %>%
  select(-pick_month,-drop_month,-pick_year,-drop_year) %>% 
  mutate(
    month = as.integer(month),
    pu_date = as.integer(pu_date),
    pu_hour = as.integer(pu_hour),
    pu_min = as.integer(pu_min),
    do_date = as.integer(do_date),
    do_hour = as.integer(do_hour),
    do_min = as.integer(do_min)
  ) %>% 
  left_join(zone_lookup, by = c("pu_location_id" = "location_id")) %>% 
  rename(
    pu_boro = borough,
    pu_zone = zone
  ) %>% 
  left_join(zone_lookup, by = c("do_location_id" = "location_id")) %>% 
  rename(
    do_boro = borough,
    do_zone = zone
  ) %>% 
  select(-pu_location_id, -do_location_id)
```

<br>   

## Destination, Time, and Taxi Use
   
#### Background and Data
   
We also looked at the yellow cab trip pattern across 24 hours in a day in the five boroughs plus Newark airport. The trip destination in the orginal data was coded in taxi zone, and information of borough was obtained by joining with the look-up table of taxi zones provided at the NYC Yellow Taxi Data webisite. Pick up time was used for the hour in a day. We then calcualted the percentage of trips in each hour among the total trips to a specific destination.

#### Heatmap of Destination Borough and Hour in a Day
   
```{r}
ax_1 <- list(
  title = "Hour of Day",
  type = 'category',
  showticklabels = TRUE)

ax_2 <- list(
  title = "Dstination",
  showticklabels = TRUE)

heatmap %>% 
  filter(do_boro != "Unknown") %>% 
  select(do_boro, pu_hour) %>% 
  mutate(
    do_boro = fct_infreq(do_boro)
  ) %>% 
  group_by(do_boro, pu_hour) %>% 
  count() %>% 
  group_by(do_boro) %>% 
  mutate( 
    total = sum(n)
    ) %>% 
   mutate(percent = round((n/total)*100,1)) %>% 
  arrange(do_boro, pu_hour) %>% 
    plot_ly(
    x = ~pu_hour, y = ~do_boro,
    height = 250, width = 900) %>%
  add_heatmap(
    z = ~percent,
    text = ~paste(
      "Trip to: ", do_boro, "<br>Pickup Time: ", pu_hour, ": 00",
      "<br>Percent: ", percent, "%"),
    hoverinfo = "text", showscale = TRUE,
    opacity = 0.90) %>%
    layout(xaxis = ax_1, yaxis = ax_2)

```


Each square in the heatmap represents a unique combination of destination boroughs and 24 hours in a day, and the color represents the percent of trip amount out of the total trip amount in that  borough,  with brighter color represents higher percent.
   
We can see that in boroughs like Staten Island, Bronx, or Brooklyn, there were more trips to these places at night or late night (8pm - 1am) than in the day time. Trips to Queens were relatively evenly spread out across hours in a day and trips to Manhattan were more likely to be in the day rather than at night. Trips to Newark had a clear peak in the afternoon hours.