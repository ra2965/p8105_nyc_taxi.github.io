---
title: "Raw Data Tidy"
author: "Xun Wang"
date: "11/25/2019"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tidyverse)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

theme_set(theme_minimal() + theme(legend.position = "bottom"))

set.seed(1)
```

### 1. Raw Data Explanation

*  **NYC Weather Data:** The weather of New York City (NYC) in 2018 raw data is from the [Global Historical Climatology Network's daily data (GHCND)](https://www.ncdc.noaa.gov/data-access/land-based-station-data/land-based-datasets/global-historical-climatology-network-ghcn). This dataset can be downloaded by `rnoaa::meteo_pull_monitors`.

*  **NYC Yellow Taxi Data:** The NYC yellow taxi raw data is from the  [TLC TriP Record Data](https://www1.nyc.gov/site/tlc/about/tlc-trip-record-data.page). It contains all the yellow taxi trip records in NYC from 2009 to 2019. First, to analyze change of the NYC yellow taxi use across 10 years, we focus on Yellow Taxi Trip Records raw data in every month of 2009, 2011, 2013, 2015, 2017. Next, to analyze change of the NYC yellow taxi use in detail, we focus on the yeat of 2018 and generate randomly sampled sub-datasets for each month in 2018. Because the raw data is too large, we put it in a folder named *raw_data* and added it to the `.gitignore` file. So the *raw_data* folder was not uploaded to the Github. The monthly sub-datasets were generated by randomly sampling 100,000 observations from each month of 2018 and saved in the folder *data*.

### 2. Datasets Generation and Cleaning

Because the raw data is too large (over 100GB), all the code chunks below are set as `eval = FALSE` after we generate sub-datasets that we need so that this Rmd file can be knitted.

##### 2.1 NYC Weather Dataset

The code chunk below generates the NYC weather dataset `weather_df` containing daily temperature and precipitation in NYC 2018 and saves the dataset as _**weather_nyc_2018.csv**_ in the folder _**data**_.

```{r weather_df, message=FALSE, eval = FALSE}

weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2018-01-01",
    date_max = "2018-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())

write.csv(weather_df, "./data/weather_nyc_2018.csv", row.names = FALSE)
```

##### 2.2 Monthly NYC Yellow Taxi Trip Datasets in 2018

The code chunk below generates the 12 NYC yellow taxi datasets with 100,000 observations randomly sampled from the yellow taxi records in each month of 2018, and saves the datasets _**yellow_tripdata_2018_month**_ in the folder _**data**_. These datasets are used for detailed analysis of the NYC yellow taxi use within a year. The code chunk below also generates a file having daily total number of taxi orders named as _**2018_taxi_trip_daily_summary**_ in the folder _**data**_.

```{r taxi_trip_2018_df, eval = FALSE}
set.seed(1)

file_name = list.files(path = "raw_data", pattern = "2018")

taxi_trip_2018_df = map(.x = file_name, ~ read_csv(str_c("raw_data/", .x)))

taxi_trip_2018_df_sampled = 
  taxi_trip_2018_df %>% 
  map(.x = ., ~janitor::clean_names(.x)) %>% 
  map(.x = ., ~sample_n(.x, 100000)) %>% 
  map(.x = ., ~arrange(.x, tpep_pickup_datetime))

map2(.x = taxi_trip_2018_df_sampled, .y = file_name, ~write.csv(.x, str_c("./data/", .y)), row.names = FALSE)  

taxi_trip_2018_df_summary = 
  taxi_trip_2018_df %>%
  map(.x = ., ~mutate(.x, date = as.Date(.x$tpep_pickup_datetime))) %>%
  map(.x = ., ~select(.x, date)) %>%
  map(.x = ., ~count(.x, vars = date)) %>% 
  bind_rows()

taxi_trip_2018_df_summary = filter(taxi_trip_2018_df_summary, n > 10000)
    
write.csv(taxi_trip_2018_df_summary, "./data/yearly_summary/2018_taxi_trip_daily_summary.csv")

```

##### 2.3 Yearly NYC Yellow Taxi Trip Datasets between 2009 and 2017.

The code chunk below generates yearly NYC yellow taxi datasets (rides, passengers, fares etc.) from the yellow taxi records in 2009, 2011, 2013, 2015, 2017, and saves the datasets in the folder _**data**_. These datasets are used for general analysis of the NYC yellow taxi use in the past 10 years.Because the data is over 100GB and our computer can't handle it all at once, we generate datasets year by year instead importing all of them once.

```{r taxi_trip_10_years_df, eval = FALSE}
file_name = list.files(path = "raw_data", pattern = "2017")

taxi_trip_2017_df = map(.x = file_name, ~ read_csv(str_c("raw_data/", .x)))

taxi_trip_2017_df_summary = 
  taxi_trip_2017_df %>% 
  map(.x = ., 
      ~summarise(.x, total_ride = nrow(.), total_passenger = sum(passenger_count), total_fare = sum(total_amount), mean_fare = mean(total_amount), median_fare = median(total_amount))
  ) %>% 
  bind_rows() %>% 
  mutate(
    file = file_name
  ) %>% 
  select(file, everything())

write.csv(taxi_trip_2017_df_summary, "./data/yearly_summary/2017_taxi_trip_summary.csv")

```


