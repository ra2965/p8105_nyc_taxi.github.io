---
title: "NYC Yellow Cab Project Report"
author: "Ran An, Xintao Ding, Xun Wang, Yuqing Xue, Xinyu Yang"
date: "12/2/2019"
output: html_document
---

### Authors

* Xun Wang: xw2417
* Ran An: ra2965
* Yuqing Xue: yx2507
* Xintao Ding: xd2222
* Xinyu Yang: xy2396


![](images/taxi.png)


## Introduction & Motivation:

Taxicab service has been around New York City for as early as the late 1890s and has since been a major player in the NYC transportation system. In 2011, the ridesharing company Uber went alive in New York City, and disrupted the taxicab business tremendously. Since the emergence of Uber, taxi usage and profits have gone down, causing the value of NYC taxi medallion to go down by more than 80%. In NYC, there are more rideshare vehicles than taxi medallion vehicles. In addition, with the increasing prevalence of smartphones, more people choose to order and pay for their rides via ride-sharing apps. 


## Initial Questions:
   
In this report, we ask the question, NYC taxicabs, besides being part of the NYC signature look, do we still need them around? Our goal is to provide data-driven insights into the taxicab operation in NYC and determine if and why NYC cabs should still be around for a while. 

**  How many passengers have NYC taxies picked up over the past couple of years? 
**  How much does weather affect the cab business? 
**  what factors might affect the tips given?
**  How did time and distance affect fare amount based on the codebook on the NYC Taxi Website?

## Data Tidy

We use public dataset from webistes 

**NYC Weather Data:** The weather of New York City (NYC) in 2018 raw data is from the [Global Historical Climatology Network's daily data (GHCND)](https://www.ncdc.noaa.gov/data-access/land-based-station-data/land-based-datasets/global-historical-climatology-network-ghcn). This dataset can be downloaded by `rnoaa::meteo_pull_monitors`.

**NYC Yellow Taxi Data:** The NYC yellow taxi raw data is from the  [TLC TriP Record Data](https://www1.nyc.gov/site/tlc/about/tlc-trip-record-data.page). 

It contains all the yellow taxi trip records in NYC from 2009 to 2019. First, to analyze change of the NYC yellow taxi use across 10 years, we focus on Yellow Taxi Trip Records raw data in every month of 2009, 2011, 2013, 2015, 2017. Next, to analyze change of the NYC yellow taxi use in detail, we focus on the year of 2018 and generate randomly sampled sub-datasets for each month in 2018. Because the raw data is too large, we put it in a folder named *raw_data* and added it to the `.gitignore` file. So the *raw_data* folder was not uploaded to the Github. The monthly sub-datasets were generated by randomly sampling 100,000 observations from each month of 2018 and saved in the folder *data*.

For weather related data, we extracted minimum temperature`tmin` and maximum temperature `tmax` and precipitation data`prcp` in 2018 and then joined with taxi data by month and date.

## Part 1 10-Year Overall Analysis of NYC Yellow Taxi Usage

#### 1. Introduction

With the development of shared traveling methods such as Uber, Lyft, VIA etc., what will the demands for NYC yellow taxi change? Will we still need these cute yellow cabs in the future? In this section, we analyze the usage of NYC yellow taxi in the past 10 years, trying to shed light on the future of the yellow cab in NYC.

#### 2. Data Import and Tidy

To analyze the overall change of NYC yellow taxi usage, we import and tidy yearly summary datasets from 2009 to 2018 in the folder *data/yearly_summary*. It combines information of rides, passenger numbers, fares in 2009, 2011, 2013, 2015, 2017, 2018 to form a `overall_df`.

```{r overall_df, include = FALSE}
file_name = list.files(path = "data/yearly_summary", pattern = "_taxi_trip_summary")

overall_df_raw = map(.x = file_name, ~ read_csv(str_c("data/yearly_summary/", .x))) 

overall_df = 
  overall_df_raw %>% 
  bind_rows() %>%
  mutate(
    time = str_remove(file, "yellow_tripdata_"),
    time = str_remove(time, ".csv"),
    total_ride_million = total_ride/1000000,
    total_passenger_million = total_passenger/1000000,
    total_fare_million = total_fare/1000000) %>% 
  separate(time, into = c("year", "month"), sep = "_", remove = TRUE) %>%
  #filter(year != 2018) %>% 
  select(year, month, total_ride_million, total_passenger_million, total_fare_million, mean_fare, median_fare)
```

#### 3. 10-Year Overall Analysis

To study changes of NYC yellow taxi usage in the past ten years, we analyze total rides, total passenger numbers, total income and median income for one trip in 2009, 2011, 2013, 2015, 2017, 2018.

##### 3.1 NYC yellow cab ride and passenger numbers are decreasing

First, we look at how the NYC yellow cab **ride number (Fig. 1)** and the **passenger number (Fig. 2)** change with time. From Figure 1, we can see that the total number of taxi rides starts to decrease since 2011 and has decreased by more than **40%** in the past 10 years, and monthly ride numbers are decreasing comparing two adjacent years. Figure 2 shows how the total passenger numbers change with time. When comparing within a single year, one interesting result is that fewer people take yellow taxis during the summer (July, August and September) even more tourists are in NYC then. When comparing among different years, the total passenger number has been also decreasing since 2011, and has also decreased by more than **40%** in the past 10 years.

Therefore, in the past 10 years, **NYC yellow cab has had fewer and fewer usage and customers!!!**

```{r total_ride_plot, echo = FALSE}
total_ride_plot = 
  overall_df %>% 
  ggplot(aes(year, weight = total_ride_million, fill = month)) +
  geom_bar(position = "stack") +
  labs(title = "Figure 1. NYC Yellow Taxi Total Rides vs. Time", 
       y = "total rides (million)",
       caption = "Data from the NYC TLC Data")

total_ride_plot
```

```{r total_passenger_plot, echo = FALSE}
total_passenger_plot = 
  overall_df %>% 
  ggplot(aes(x = month, y = total_passenger_million, color = year, group = year)) +
  geom_line(size = 2) +
  labs(title = "Figure 2. NYC Yellow Taxi Passenger vs. Time", 
       y = "total passenger (million)",
       caption = "Data from the NYC TLC Data")

total_passenger_plot
```

##### 3.2 NYC yellow cab is more expensive for a single ride 

Second, we look at how the price of taking a yellow cub changes with time and plot the relationship between media fare for a single trip and time time as Figure 3. From Figure 3, we can see that the median fare for a single trip is increasing within a year and among different years with time goes by. For a single trip, the median fare has increased by about **45%**.

Therefore, in the past 10 years, **NYC yellow cab has become more and more expensive!!!**

```{r median_fare_plot, echo = FALSE}
median_fare_plot =
  overall_df %>% 
  ggplot(aes(x = month, y = mean_fare, color = year, group = year)) +
  geom_line(size = 2) +
  labs(title = "Figure 3. NYC Yellow Taxi Median Fare vs. Time", 
       y = "median fare for one trip (US dollar)",
       caption = "Data from the NYC TLC Data")

median_fare_plot
```

##### 3.3 NYC yellow cab gets lower income 

At last, we look at how the gross income from the NYC yellow cab changes with time. We plot the relationship between total income and time as Figure 4. From Figure 4, we can see that the total income from the NYC yellow cab reaches to the peak in 2013. This might because the customer number didn't decrease too much while the median fare for a single trip increased a lot in 2013 compared with 2012. However, the total income has decreased by about **30%** (amost 1 billion dollars!) in the past 5 years. 

Therefore, **the total income from the NYC yellow cab has been decreasing since 2013**. 

```{r total_fare_plot, echo = FALSE}
total_fare_plot = 
  overall_df %>% 
  ggplot(aes(year, weight = total_fare_million, fill = month)) +
  geom_bar(position = "stack") +
  labs(title = "Figure 4. NYC Yellow Taxi Total Income vs. Time", 
       y = "total income (million US dollar)",
       caption = "Data from the NYC TLC Data")

total_fare_plot
```

#### 4. Conclusion

From the analysis of overall data of the NYC yellow cab in the past 10 years, we know that with time goes by, fewer and fewer people are using the NYC yellow cab. Even though the fare for a single trip is increasing, the total income from these cute cabs is decreasing and almost 1 billion dollars vanished in 2018 compared with 2013. Therefore, the future of the NYC yellow cab is not very bright. Good luck! 

## Part 2 2018 Trip Pattern

#### Temperature and Taxi Use
   
##### Background

Previous work have shown that there are relationships between taxi ridership and weather events.“During adverse weather, taxi drivers tend to make more money” (Kamga et al., 2013). Kamga et al. also found that during days when adverse weather took place, there was a higher demand for taxis in Manhattan compared to the other boroughs, and that more people were prone to take shorter taxi trips.

##### Data Tidy

In this part, we wanted to see whether there is a trend between weather and yellow cab within and between months use using our data. We used the weather data including temperature and precipitation data in 2018 and their corresponding yellow taxi use data. For temperature, we used average temperature `average_temp ` as the mean of maximum temperarure and miniminum temperature in each day. For yellow cab data, we used the raw data for 2018 from NYC Taxi Website, counted the daily taxi usage by `pick_up_data` and then joined the weather dataset by month and date.


```{r message = FALSE, warning = FALSE}
weather_tot=read_csv(file = "./data/weather_nyc_2018.csv")%>%
  mutate(date = as.character(date)) %>%
  separate(date, into = c("year","month","pu_date"), sep = "-", convert = TRUE)%>%
  mutate(
  average_temp=(tmin+tmax)/2)
  

yellowcab=read_csv(file = "./data/yearly_summary/2018_taxi_trip_daily_summary.csv")%>%
  mutate(date = as.character(vars),
         daily_drive=n) %>%
  separate(date, into = c("year","month","pu_date"), sep = "-", convert = TRUE)%>%
  select(-vars,-year)

cab_weather=
  left_join(weather_tot,yellowcab, by=c("month","pu_date"))%>%
  select(month, pu_date,average_temp, daily_drive,prcp)%>%
  mutate(month=as.factor(month),
         month=recode_factor(month, '1'="January", '2'="Feburary",'3'="March",'4'='April','5'='May','6'='June','7'='July','8'='August','9'='September','10'='October','11'='November','12'='December'))
```

##### Plot for the association between Weather and Daily Taxi Usage

Here we made an animation plot to show the daily drive amount and average daily temperature for each month.The size of the dots showed the precipitaiton for that day which help to identify whether rainy weather also increase taxi use. 

Although we hypothesized that cold weather and hot weather might have more taxi use, there was no obvious usage increase in summer time. While, we did observed high daily drive amount in Feburary, March and April which are the four coldest months in NYC. Also, no interaction between month and average temperature was being observed. In terms of the influence of precipitation, we didn't observe a significant pattern. Contrast to what we guessed before, instead of increase daily drive amount, rainy days had lower drive amount. This might due to the reason that people would just stay at home during days with heavy rain or snow. Also, if we adjustded for distance, there might be a significant association between precipitation and short distance drive. 

```{r message = FALSE, warning = FALSE}
weather_plot=cab_weather %>%
  ggplot(aes(x=average_temp, y=daily_drive, frame_vars(month)))+
  geom_point(aes(size=prcp,colour = month))+
   labs(title = 'Month: {closest_state}',
       x = 'Daily Average Temperature for Year 2018 &#8451;', 
       y = 'Daily Drive Amount',
       colour = 'Month',
       size='Precipitation'
       ) +
  transition_states(month,2,1)+
  enter_appear()+
  exit_fade()
   
animate(weather_plot, duration=12)
```


```{r, include=FALSE}
zone_lookup <-
  read_csv("./data/taxi_zone_lookup.csv") %>% 
  janitor::clean_names() %>% 
  select(-service_zone)

file_names <- list.files("./data/yellow_cab")
read_in = function(x) {
  read_csv("./data/yellow_cab/x") 
}
setwd("./data/yellow_cab")
taxi_2018 <-
  file_names %>% 
  set_names() %>% 
  map_dfr(read_csv, .id = "source") %>% 
  separate(source, c("a","b","year", "month", "c"), sep = "([\\.\\_])") %>% 
  select(-a, -b, -c, -X1)

```

```{r}
heatmap <-
  taxi_2018 %>% 
  filter(
    passenger_count != 0,
    trip_distance != 0,
    total_amount > 0,
    fare_amount != 0
  ) %>% 
  mutate(tpep_pickup_datetime = as.character(tpep_pickup_datetime),
         tpep_dropoff_datetime = as.character(tpep_dropoff_datetime)) %>%
  separate(tpep_pickup_datetime, into = c("a","b"), sep = " ") %>%
  separate(a, into = c("pick_year","pick_month","pu_date"), sep = "-") %>%
  separate(b, into = c("pu_hour","pu_min"), sep = ":") %>%
  separate(tpep_dropoff_datetime, into = c("c","d"),sep = " ") %>%
  separate(c,into = c("drop_year","drop_month","do_date"),sep = "-") %>%
  separate(d, into = c("do_hour","do_min"), sep = ":") %>%
  select(-pick_month,-drop_month,-pick_year,-drop_year) %>% 
  mutate(
    month = as.integer(month),
    pu_date = as.integer(pu_date),
    pu_hour = as.integer(pu_hour),
    pu_min = as.integer(pu_min),
    do_date = as.integer(do_date),
    do_hour = as.integer(do_hour),
    do_min = as.integer(do_min)
  ) %>% 
  left_join(zone_lookup, by = c("pu_location_id" = "location_id")) %>% 
  rename(
    pu_boro = borough,
    pu_zone = zone
  ) %>% 
  left_join(zone_lookup, by = c("do_location_id" = "location_id")) %>% 
  rename(
    do_boro = borough,
    do_zone = zone
  ) %>% 
  select(-pu_location_id, -do_location_id)
```

<br>   

#### Destination, Time, and Taxi Use
   
##### Background and Data
   
We also looked at the yellow cab trip pattern across 24 hours in a day in the five boroughs plus Newark airport. The trip destination in the orginal data was coded in taxi zone, and information of borough was obtained by joining with the look-up table of taxi zones provided at the NYC Yellow Taxi Data webisite. Pick up time was used for the hour in a day. We then calcualted the percentage of trips in each hour among the total trips to a specific destination.

##### Heatmap of Destination Borough and Hour in a Day
   
```{r}
ax_1 <- list(
  title = "Hour in Day",
  type = 'category',
  showticklabels = TRUE)

ax_2 <- list(
  title = "Dstination",
  showticklabels = TRUE)

heatmap %>% 
  filter(do_boro != "Unknown") %>% 
  select (do_boro, pu_hour) %>% 
  mutate(
    do_boro = fct_infreq(do_boro)
  ) %>% 
  group_by(do_boro, pu_hour) %>% 
  count() %>% 
  group_by(do_boro) %>% 
  mutate( 
    total = sum(n)
    ) %>% 
   mutate(percent = round((n/total)*100,1)) %>% 
  arrange(do_boro, pu_hour) %>% 
    plot_ly(
    x = ~pu_hour, y = ~do_boro,
    height = 400, width = 1400) %>%
  add_heatmap(
    z = ~percent,
    text = ~paste(
      "Trip to: ", do_boro, "<br>Pickup Time: ", pu_hour, ": 00",
      "<br>Percent: ", percent, "%"),
    hoverinfo = "text", showscale = TRUE,
    opacity = 0.90) %>%
    layout(xaxis = ax_1, yaxis = ax_2)

```


Each square in the heatmap represents a unique combination of destination boroughs and 24 hours in a day, and the color represents the percent of trip amount out of the total trip amount in that  borough,  with brighter color represents higher percent.
   
We can see that in boroughs like Staten Island, Bronx, or Brroklyn, there were more trips to these places in night or late night (8pm - 1am) than in the day time. Trips to Queens were relatively evenly spread out across hours in a day and trips to Manhattan were more likely to be in the day  rather than in the night. Trips to Newark had a clear peak in the afternoon hours.

## Part 3 Fare 




## Discussion